<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grafik Kebutuhan Jemaat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for loading spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            -webkit-animation: spin 2s linear infinite; /* Safari */
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 max-w-lg">
        <div class="bg-white rounded-xl shadow-md p-6">
            
            <!-- Header -->
            <div id="header">
                <h1 class="text-2xl font-bold text-gray-800">Grafik Kebutuhan Jemaat</h1>
                <p class="text-gray-500 mt-1">Pilih periode untuk melihat visualisasi data.</p>
            </div>

            <!-- Selection View -->
            <div id="selectionView" class="mt-6">
                <div class="space-y-3">
                    <button onclick="generateChart('weekly')" class="w-full text-left p-4 bg-gray-50 hover:bg-blue-100 rounded-lg transition duration-200">
                        <h3 class="font-semibold text-gray-700">Mingguan</h3>
                        <p class="text-sm text-gray-500">Tampilkan data 7 hari terakhir.</p>
                    </button>
                    <button onclick="generateChart('monthly')" class="w-full text-left p-4 bg-gray-50 hover:bg-blue-100 rounded-lg transition duration-200">
                        <h3 class="font-semibold text-gray-700">Bulanan</h3>
                        <p class="text-sm text-gray-500">Tampilkan data 30 hari terakhir.</p>
                    </button>
                    
                    <!-- Custom Date Range -->
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-semibold text-gray-700">Custom</h3>
                        <p class="text-sm text-gray-500 mb-3">Pilih rentang tanggal sendiri.</p>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <div class="w-full">
                                <label for="startDate" class="text-xs font-medium text-gray-600">Tanggal Awal</label>
                                <input type="date" id="startDate" class="w-full mt-1 p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="w-full">
                                <label for="endDate" class="text-xs font-medium text-gray-600">Tanggal Akhir</label>
                                <input type="date" id="endDate" class="w-full mt-1 p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <button onclick="generateChart('custom')" class="w-full mt-4 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200">
                            Tampilkan Grafik Custom
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chart View -->
            <div id="chartView" class="hidden mt-6 text-center">
                <button onclick="showSelection()" class="mb-4 text-sm text-blue-600 hover:underline">&larr; Kembali ke Pilihan</button>
                <h2 id="chartTitle" class="text-xl font-bold text-gray-800 mb-4"></h2>
                <div id="loadingIndicator" class="flex justify-center items-center h-64">
                    <div class="loader"></div>
                </div>
                <div id="chartContainer" class="hidden">
                    <img id="chartImage" src="" alt="Grafik Kebutuhan Jemaat" class="w-full h-auto rounded-lg shadow-inner bg-gray-50">
                </div>
                <div id="errorContainer" class="hidden mt-4 p-4 bg-red-100 text-red-700 rounded-lg">
                    <p id="errorMessage"></p>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // Ganti dengan URL Webhook n8n Anda
        const N8N_WEBHOOK_URL = 'https://n8n.yourdomain.com/webhook/your-webhook-id';

        // --- UI ELEMENTS ---
        const selectionView = document.getElementById('selectionView');
        const chartView = document.getElementById('chartView');
        const chartTitle = document.getElementById('chartTitle');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const chartContainer = document.getElementById('chartContainer');
        const chartImage = document.getElementById('chartImage');
        const errorContainer = document.getElementById('errorContainer');
        const errorMessage = document.getElementById('errorMessage');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');

        // --- FUNCTIONS ---

        function showSelection() {
            chartView.classList.add('hidden');
            selectionView.classList.remove('hidden');
            document.getElementById('header').classList.remove('hidden');
        }

        function showChartView() {
            selectionView.classList.add('hidden');
            chartView.classList.remove('hidden');
            document.getElementById('header').classList.add('hidden');
            
            // Reset state
            loadingIndicator.style.display = 'flex';
            chartContainer.classList.add('hidden');
            errorContainer.classList.add('hidden');
            chartImage.src = '';
        }

        async function generateChart(period) {
            showChartView();

            let url = `${N8N_WEBHOOK_URL}?period=${period}`;
            let title = '';

            if (period === 'weekly') {
                title = 'Grafik Kebutuhan: Mingguan';
            } else if (period === 'monthly') {
                title = 'Grafik Kebutuhan: Bulanan';
            } else if (period === 'custom') {
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;

                if (!startDate || !endDate) {
                    displayError('Tanggal awal dan tanggal akhir harus diisi untuk periode custom.');
                    return;
                }
                if (new Date(startDate) > new Date(endDate)) {
                    displayError('Tanggal awal tidak boleh lebih besar dari tanggal akhir.');
                    return;
                }
                
                url += `&start=${startDate}&end=${endDate}`;
                title = `Grafik Kebutuhan: ${startDate} s/d ${endDate}`;
            }
            
            chartTitle.textContent = title;

            try {
                // Panggil webhook n8n
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Terjadi masalah saat menghubungi server: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success && result.chartUrl) {
                    // Tampilkan grafik jika berhasil
                    chartImage.src = result.chartUrl;
                    chartContainer.classList.remove('hidden');
                } else {
                    // Tampilkan pesan error dari n8n
                    throw new Error(result.error || 'Gagal membuat grafik. Format respons tidak sesuai.');
                }

            } catch (error) {
                displayError(error.message || 'Tidak dapat mengambil data grafik. Periksa koneksi Anda atau hubungi admin.');
            } finally {
                // Sembunyikan loading indicator
                loadingIndicator.style.display = 'none';
            }
        }
        
        function displayError(message) {
            errorMessage.textContent = message;
            errorContainer.classList.remove('hidden');
            loadingIndicator.style.display = 'none';
        }

    </script>

</body>
</html>
