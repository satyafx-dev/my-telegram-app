<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skill Selector</title>
    
    <link href="https://unpkg.com/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />
    
    <style>
        :root {
            --bg-color: #1c2431;
            --text-color: #ffffff;
            --button-color: #5288c1;
            --button-text-color: #ffffff;
            --input-bg-color: #2b374a;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .container {
            width: 100%;
            max-width: 500px;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 20px;
        }
        p {
            font-size: 16px;
            color: #b0b8c4;
            margin-bottom: 30px;
        }
        .tagify {
            --tags-bg: var(--input-bg-color);
            --tags-text-color: var(--text-color);
            --tag-bg: var(--button-color);
            --tag-hover: #416b99;
            --tag-text-color: var(--button-text-color);
            border: none;
            width: 100%;
        }
        .tagify__input {
            color: var(--text-color);
        }
        button {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            color: var(--button-text-color);
            background-color: var(--button-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 30px;
            transition: background-color 0.2s;
        }
        button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        #message {
            margin-top: 15px;
            font-size: 14px;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Atur Skill Anda</h1>
        <p>Ketik skill Anda lalu tekan 'Enter'. Anda bisa menambahkan beberapa skill sekaligus.</p>
        
        <input name='skills-input' placeholder='contoh: Java, Python, Akuntansi...'>

        <button id="saveButton">Simpan Skill</button>
        <div id="message"></div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script src="https://unpkg.com/@yaireo/tagify"></script>
    <script src="https://unpkg.com/@yaireo/tagify/dist/tagify.polyfills.min.js"></script>

    <script type="module">
        // Impor Supabase Client
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- KONFIGURASI ---
        // GANTI DENGAN URL DAN ANON KEY SUPABASE ANDA
        const SUPABASE_URL = 'https://YOR_PROJECT_ID.supabase.co';
        const SUPABASE_ANON_KEY = 'YOUR_ANON_KEY';
        // -----------------

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const tg = window.Telegram.WebApp;

        // Inisialisasi Tagify pada elemen input
        const input = document.querySelector('input[name=skills-input]');
        const tagify = new Tagify(input);

        const saveButton = document.getElementById('saveButton');
        const messageDiv = document.getElementById('message');

        // Fungsi untuk menampilkan pesan
        const showMessage = (text, isError = false) => {
            messageDiv.textContent = text;
            messageDiv.style.color = isError ? '#ff7675' : '#2ecc71';
        };

        // Fungsi untuk menyimpan data
        const saveSkills = async () => {
            if (!tg.initDataUnsafe?.user) {
                showMessage('Tidak dapat menemukan data user Telegram.', true);
                return;
            }

            // Ambil data user dari Telegram
            const user = tg.initDataUnsafe.user;
            // NOTE: Supabase membutuhkan UUID, tapi telegram user_id adalah integer.
            // Kita akan membuat UUID dummy berdasarkan user_id, atau idealnya Anda perlu mekanisme JWT.
            // Untuk kesederhanaan, kita akan skip bagian otentikasi JWT dan langsung insert.
            // Di production, Anda harus memvalidasi data user di backend dan membuat JWT.
            
            // Untuk tujuan demo ini, kita akan fokus pada penyimpanan data.
            // Anda perlu membuat UUID yang konsisten untuk user_id di backend Anda.
            // Namun, karena di SQL kita set user_id sebagai PRIMARY KEY, kita tidak bisa
            // menggunakan integer dari telegram. Solusi sementara: kita lewati RLS 
            // dan gunakan kolom `chat_id` sebagai gantinya untuk identifikasi unik.
            // Atau, kita bisa membuat UUID dari chat_id (tidak ideal, tapi bisa untuk demo).
            // Pilihan terbaik adalah menggunakan user_id (bigint) sebagai PK. Mari kita asumsikan 
            // Anda mengubah `user_id UUID` menjadi `user_id BIGINT` di tabel SQL.
            
            const userId = user.id; // Ini adalah integer, misalnya 12345678
            const chatId = user.id; // Untuk private chat, user.id sama dengan chat.id
            
            const skills = tagify.value.map(tag => tag.value);

            saveButton.disabled = true;
            saveButton.textContent = 'Menyimpan...';

            try {
                // Gunakan upsert: update jika user_id sudah ada, insert jika belum.
                const { data, error } = await supabase
                    .from('free_users_skill')
                    .upsert({ 
                        // Jika Anda tetap pakai UUID, Anda perlu generate UUID dari user.id di backend
                        // Untuk sekarang, kita asumsikan kolom user_id di SQL diubah jadi BIGINT
                        user_id: userId, 
                        chat_id: chatId,
                        skills: skills 
                    }, { onConflict: 'user_id' }); // onConflict memastikan upsert berjalan pada kolom yang benar

                if (error) throw error;

                showMessage('Skill berhasil disimpan!');
                tg.HapticFeedback.notificationOccurred('success');
                
                // Tutup Web App setelah 2 detik
                setTimeout(() => {
                    tg.close();
                }, 2000);

            } catch (error) {
                console.error('Error saving skills:', error);
                showMessage(`Gagal menyimpan: ${error.message}`, true);
                tg.HapticFeedback.notificationOccurred('error');
                saveButton.disabled = false;
                saveButton.textContent = 'Simpan Skill';
            }
        };

        // Event listener saat halaman dimuat
        document.addEventListener('DOMContentLoaded', () => {
            tg.ready();
            // Membuat tombol utama Telegram untuk fungsi simpan
            tg.MainButton.text = "SIMPAN SKILL";
            tg.MainButton.show();
            tg.MainButton.onClick(saveSkills);
        });

        // Event listener untuk tombol HTML (sebagai alternatif)
        saveButton.addEventListener('click', saveSkills);
        
    </script>
</body>
</html>
